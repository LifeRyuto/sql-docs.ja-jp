---
title: ドライバー マネージャー接続プール |マイクロソフトドキュメント
ms.custom: ''
ms.date: 01/19/2017
ms.prod: sql
ms.prod_service: connectivity
ms.reviewer: ''
ms.technology: connectivity
ms.topic: conceptual
helpviewer_keywords:
- connection pooling [ODBC]
- pooled connections [ODBC]
- connecting to driver [ODBC], connection pooling
- connecting to data source [ODBC], connection pooling
ms.assetid: ee95ffdb-5aa1-49a3-beb2-7695b27c3df9
author: David-Engel
ms.author: v-daenge
ms.openlocfilehash: 84ccc0db8f9a54eecc8337ca5efbc7b4c4baa239
ms.sourcegitcommit: ce94c2ad7a50945481172782c270b5b0206e61de
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/14/2020
ms.locfileid: "81305823"
---
# <a name="driver-manager-connection-pooling"></a>ドライバー マネージャーの接続プール
接続プールを使用すると、アプリケーションは、使用ごとに再確立する必要のない接続プールからの接続を使用できます。 接続が作成されてプールに配置されると、アプリケーションは接続プロセス全体を実行しなくてもその接続を再利用できます。  
  
 プール接続を使用すると、アプリケーションが接続の作成に伴うオーバーヘッドを節約できるため、パフォーマンスが大幅に向上する可能性があります。 これは、ネットワーク経由で接続する中間層アプリケーションや、インターネット アプリケーションなど、接続と切断を繰り返すアプリケーションでは特に重要です。  
  
 パフォーマンスの向上に加えて、接続プール アーキテクチャでは、環境とその関連付けられた接続を 1 つのプロセス内の複数のコンポーネントで使用できます。 つまり、同じプロセス内のスタンドアロン コンポーネントは、互いに認識されることなく相互に対話できます。 接続プール内の接続は、複数のコンポーネントで繰り返し使用できます。  
  
> [!NOTE]
>  接続プールは、ODBC 2 を使用する ODBC アプリケーションで使用できます。*x*動作 (アプリケーションが*SQLSetEnvAttr*を呼び出すことができる限り)。 接続プールを使用する場合、データベースまたはデータベースのコンテキストを変更する SQL ステートメント (データベース\<*名*>変更など) を実行して、データ ソースが使用するカタログを変更する必要があります。  


 ODBC ドライバーはスレッド セーフであり、接続のプールをサポートするスレッド アフィニティを持たない接続を使用する必要があります。 つまり、ドライバーは、任意のスレッドでいつでも呼び出しを処理し、あるスレッドで接続し、別のスレッドで接続を使用し、3 番目のスレッドで切断することができます。  
  
 接続プールは、ドライバー マネージャーによって維持されます。 接続は、アプリケーションが SQLConnect または**SQLDriverConnect**を呼び出すとプールから描画され、アプリケーションが**SQLDriverConnect****SQLDisconnect**を呼び出すとプールに返されます。 プールのサイズは、要求されたリソース割り当てに基づいて動的に大きくなります。 非アクティブ タイムアウトに基づいて縮小する: 接続が一定期間非アクティブである場合 (接続で使用されていない場合)、プールから削除されます。 プールのサイズは、サーバー上のメモリの制約と制限によってのみ制限されます。  
  
 ドライバー マネージャーは **、SQLConnect**または**SQLDriverConnect**で渡された引数に従って、接続が割り当てられた後に設定された接続属性に従って、プール内の特定の接続を使用するかどうかを決定します。  
  
 ドライバ マネージャが接続をプールしている場合、接続を渡す前に接続がまだ機能しているかどうかを判断できる必要があります。 それ以外の場合、ドライバー マネージャーは、一時的なネットワーク障害が発生するたびに、アプリケーションに接続が切断されたを渡し続けます。 新しい接続属性が ODBC 3 *.x*: SQL_ATTR_CONNECTION_DEADで定義されました。 これは、SQL_CD_TRUEまたはSQL_CD_FALSEを返す読み取り専用の接続属性です。 SQL_CD_TRUE値は接続が失われたことを示し、SQL_CD_FALSE値は接続がまだアクティブであることを意味します。 (ODBC の以前のバージョンに準拠しているドライバーもこの属性をサポートできます。  
  
 ドライバーは、このオプションを効率的に実装する必要があります、接続プールのパフォーマンスを低下します。 具体的には、この接続属性を取得する呼び出しは、サーバーへのラウンド トリップを発生させるべきではありません。 代わりに、ドライバーは、接続の最後の既知の状態を返す必要があります。 サーバーへの最後のトリップが失敗した場合、接続は停止し、最後のトリップが成功した場合は接続は停止しません。  
  
## <a name="remarks"></a>解説  
 接続が失われた場合 (SQL_ATTR_CONNECTION_DEADを介して報告される)、ODBC ドライバー マネージャーは、ドライバーで SQLDisconnect を呼び出すことによって、その接続を破棄します。 新しい接続要求では、プール内で使用できる接続が見つからない可能性があります。 最終的に、ドライバー マネージャーは、プールが空であると仮定して、新しい接続を作成する可能性があります。  
  
 接続プールを使用するには、アプリケーションは次の手順を実行します。  
  
1.  **SQLSetEnvAttr**を呼び出して接続プールを有効にして、SQL_ATTR_CONNECTION_POOLING環境属性をSQL_CP_ONE_PER_DRIVERまたはSQL_CP_ONE_PER_HENVに設定します。 この呼び出しは、アプリケーションが接続プールを有効にする共有環境を割り当てる前に行う必要があります。 **SQLSetEnvAttr**の呼び出しで環境ハンドルは、プロセス レベルの属性SQL_ATTR_CONNECTION_POOLINGを作成する null に設定する必要があります。 属性がSQL_CP_ONE_PER_DRIVERに設定されている場合、各ドライバーに対して 1 つの接続プールがサポートされます。 アプリケーションが多数のドライバーと少数の環境で動作する場合、比較が必要になる可能性が少ないため、この方法の方が効率的な場合があります。 SQL_CP_ONE_PER_HENVに設定すると、環境ごとに 1 つの接続プールがサポートされます。 アプリケーションが多くの環境で動作し、少数のドライバーで動作する場合、比較が必要になる可能性が少ないため、この方法の方が効率的な場合があります。 接続プールは、SQL_ATTR_CONNECTION_POOLINGを SQL_CP_OFF に設定することで無効になります。  
  
2.  *引数を*SQL_HANDLE_ENV に設定して**SQLAllocHandle**を呼び出して、環境を割り当てます。 接続プールが有効になっているため、この呼び出しによって割り当てられる環境は暗黙的な共有環境になります。 ただし、この環境で*ハンドル型*の SQL_HANDLE_DBC を持つ**SQLAllocHandle**が呼び出されるまで、使用する環境は決定されません。  
  
3.  *入力*ハンドルを SQL_HANDLE_DBC に設定して**SQLAllocHandle**を呼び出し、接続プール用に割り当てられた環境ハンドルに設定された*InputHandle*を呼び出すことによって、接続を割り当てます。 ドライバー マネージャーは、アプリケーションによって設定された環境属性に一致する既存の環境を検索しようとします。 そのような環境が存在しない場合は、1 が作成され、(ドライバー マネージャーによって管理される) 参照カウントが 1 になります。 一致する共有環境が見つかった場合、環境はアプリケーションに戻され、その参照カウントはインクリメントされます。 (実際に使用される接続は **、SQLConnect**または**SQL ドライバ接続**が呼び出されるまで、ドライバー マネージャーによって決定されません。  
  
4.  接続を行うために**SQL 接続**または**SQL ドライバー接続**を呼び出します。 ドライバー マネージャーは **、SQLConnect**への呼び出しで接続オプション (または**SQLDriverConnect**の呼び出しで接続キーワード) と、プール内の接続を決定する接続の割り当て後に設定された接続属性を使用します。  
  
    > [!NOTE]  
    >  要求された接続がプールされた接続に対してどのように一致するかを、SQL_ATTR_CP_MATCH環境属性によって決定されます。 詳細については、「 [SQLSetEnvAttr](../../../odbc/reference/syntax/sqlsetenvattr-function.md)」を参照してください。  
  
     接続プールを使用する ODBC アプリケーションは、アプリケーションの初期化時に[CoInitializeEx を](https://go.microsoft.com/fwlink/?LinkID=116307)呼び出し、アプリケーションが閉じるときに[CoUninitialize](https://go.microsoft.com/fwlink/?LinkId=116310)を呼び出す必要があります。  
  
5.  接続が完了すると **、SQLDisconnect**を呼び出します。 接続が接続プールに戻され、再利用できるようになります。  
  
 詳細については、「 Microsoft データ[アクセス コンポーネントのプール](https://go.microsoft.com/fwlink/?LinkId=120776)」を参照してください。  
  
## <a name="connection-pooling-considerations"></a>接続プールに関する考慮事項  
 ODBC API ではなく SQL コマンドを使用して次のいずれかのアクションを実行すると、接続の状態に影響を与え、接続プーリングがアクティブな場合に予期しない問題が発生する可能性があります。  
  
-   接続を開き、既定のデータベースを変更する。  
  
-   SET ステートメントを使用して、構成可能なオプション (SET 行カウント、ANSI_NULL、IMPLICIT_TRANSACTIONS、プラン表示、統計、テキストサイズ、および日付形式を含む) を変更します。  
  
-   一時テーブルとストアド プロシージャを作成する。  
  
 これらのアクションのいずれかが ODBC API の外部で実行された場合、接続を使用する次のユーザーは、以前の設定、テーブル、またはプロシージャを自動的に継承します。  
  
> [!NOTE]  
>  接続状態で特定の設定が存在するとは思わない。 アプリケーションでは常に接続状態を設定し、アプリケーションが未使用の接続プール設定を削除することを確認する必要があります。  
  
## <a name="driver-aware-connection-pooling"></a>ドライバー対応接続プール  
 Windows 8 以降では、ODBC ドライバーは、プール内の接続をより効率的に使用できます。 詳細については、「[ドライバ対応接続プール](../../../odbc/reference/develop-app/driver-aware-connection-pooling.md)」を参照してください。  
  
## <a name="see-also"></a>参照  
 [データ ソースまたはドライバへの接続](../../../odbc/reference/develop-app/connecting-to-a-data-source-or-driver.md)   
 [ODBC ドライバーの開発](../../../odbc/reference/develop-driver/developing-an-odbc-driver.md)   
 [Microsoft データ アクセス コンポーネントでのプール](https://go.microsoft.com/fwlink/?LinkId=120776)
