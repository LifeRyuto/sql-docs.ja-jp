---
title: セキュリティで保護されたエンクレーブが設定された Always Encrypted (データベース エンジン) | Microsoft Docs
ms.custom: ''
ms.date: 09/24/2018
ms.prod: sql
ms.prod_service: database-engine, sql-database
ms.reviewer: ''
ms.technology: security
ms.topic: conceptual
author: jaszymas
ms.author: jaszymas
manager: craigg
monikerRange: '>= sql-server-ver15 || = sqlallproducts-allversions'
ms.openlocfilehash: 377c2d95564e7348bdfb5de9480c7c7f5004c7f7
ms.sourcegitcommit: 3026c22b7fba19059a769ea5f367c4f51efaf286
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/15/2019
ms.locfileid: "65938162"
---
# <a name="always-encrypted-with-secure-enclaves"></a>セキュリティで保護されたエンクレーブが設定された Always Encrypted
[!INCLUDE[tsql-appliesto-ssver15-xxxx-xxxx-xxx](../../../includes/tsql-appliesto-ssver15-xxxx-xxxx-xxx.md)]


セキュリティで保護されたエンクレーブが設定された Always Encrypted は、[Always Encrypted](always-encrypted-database-engine.md) 機能に追加機能を提供します。

SQL Server 2016 で導入された Always Encrypted は、注意が必要なデータの機密性を、マルウェアと、SQL Server の高い特権を持つ*未承認*の SQL ユーザーから保護します。 高い特権を持つ未承認のユーザーとは、DBA、コンピューター管理者、クラウド管理者、またはサーバー インスタンス、ハードウェアなどに対する正当なアクセス権を持ち、実際のデータの一部またはすべてにアクセスすべきではないユーザーです。 

これまで Always Encrypted では、クライアント側でデータを暗号化し、データまたは対応する暗号化キーが SQL Server Engine 内でプレーンテキストで表示されないようにすることで、データを保護していました。 その結果、データベース内の暗号化された列に対する機能が大幅に制限されていました。 SQL Server で暗号化されたデータに対して実行できる操作は、等価比較のみでした (また、等価比較は決定論的な暗号化でのみ使用できました)。 暗号化操作 (最初のデータ暗号化、キーの交換) や高度な計算 (パターン マッチングなど) を含む他のすべての操作は、データベース内ではサポートされていませんでした。 ユーザーがクライアント側でこのような操作を実行するには、データベースの外部にデータを移動する必要がありました。

*セキュリティで保護されたエンクレーブ*が設定された Always Encrypted では、サーバー側でセキュリティで保護されたエンクレーブ内のプレーンテキストに対する計算を許可することで、このような制限に対応しています。 セキュリティで保護されたエンクレーブは、SQL Server プロセス内のメモリの保護された領域であり、SQL Server エンジン内の機密データを処理するための信頼できる実行環境として機能します。 セキュリティで保護されたエンクレーブは、その他の SQL Server やホスティング マシン上の他のプロセスに対してはブラック ボックスに見えます。 デバッガーを使用しても、外部からエンクレーブ内のデータやコードを表示する方法はありません。  


Always Encrypted は、次の図のようにセキュリティで保護されたエンクレーブを使用します。

![データ フロー (data flow)](./media/always-encrypted-enclaves/ae-data-flow.png)



SQL Server Engine は、アプリケーションのクエリを解析するときに、セキュリティで保護されたエンクレーブを使用する必要がある暗号化されたデータに対する操作がクエリに含まれているかどうかを判断します。 セキュリティで保護されたエンクレーブにアクセスする必要があるクエリの場合:

- クライアント ドライバーから、操作に必要な列の暗号化キーが (セキュリティで保護されたチャネルを介して) セキュリティで保護されたエンクレーブに送信されます。 
- 次に、クライアント ドライバーから、暗号化されたクエリ パラメーターと共に実行に関するクエリが送信されます。

クエリ処理時に、データまたは列の暗号化キーは、セキュリティで保護されたエンクレーブの外部にある SQL Server エンジンではプレーンテキストで公開されません。 SQL Server エンジンは、暗号化された列に対する暗号化操作と計算をセキュリティで保護されたエンクレーブに委任します。 セキュリティで保護されたエンクレーブでは、必要に応じて、暗号化された列に格納されているクエリ パラメーターやデータが復号化され、要求された操作が実行されます。

## <a name="why-use-always-encrypted-with-secure-enclaves"></a>セキュリティで保護されたエンクレーブが設定された Always Encrypted を使用する理由

セキュリティで保護されたエンクレーブを設定して Always Encrypted を使用すると、注意が必要なデータの機密性を保護できるだけでなく、次の利点もあります。

- **インプレース暗号化**: 最初のデータ暗号化や列暗号化キーの交換など、機密データに対する暗号化操作はセキュリティで保護されたエンクレーブ内で実行され、データをデータベースの外部に移動する必要はありません。 ALTER TABLE Transact-SQL ステートメントを使用してインプレース暗号化を発行することができます。SSMS の Always Encrypted ウィザードや Set-SqlColumnEncryption PowerShell コマンドレットなどのツールを使用する必要はありません。

- **高度な計算 (プレビュー)** : パターン マッチング (LIKE 述語) と範囲比較など、暗号化された列に対する操作は、セキュリティで保護されたエンクレーブ内でサポートされます。そのため、データベース システム内でこのような計算を実行する必要がある幅広いアプリケーションやシナリオに Always Encrypted を使用できます。

> [!IMPORTANT]
> [!INCLUDE[sql-server-2019](../../../includes/sssqlv15-md.md)] では、高度な計算は、いくつかのパフォーマンスの最適化について保留中であり、機能が制限 (インデックス作成がないなど) されていて、現在は既定で無効になっています。 [高度な計算を有効にする](configure-always-encrypted-enclaves.md#configure-a-secure-enclave)方法に関するページを参照してください。

[!INCLUDE[sql-server-2019](../../../includes/sssqlv15-md.md)] のセキュリティで保護されたエンクレーブが設定された Always Encrypted は、Windows で[仮想化ベースのセキュリティ (VBS)](https://www.microsoft.com/security/blog/2018/06/05/virtualization-based-security-vbs-memory-enclaves-data-protection-through-isolation/) のセキュリティで保護されたメモリ エンクレーブ (仮想保護モード (VSM) エンクレーブとも呼ばれます) を使用します。

## <a name="secure-enclave-attestation"></a>セキュリティで保護されたエンクレーブの構成証明

SQL Server エンジン内のセキュリティで保護されたエンクレーブは、暗号化されたデータベース列に格納されている機密データと、それに対応するプレーンテキストの列の暗号化キーにアクセスできます。 エンクレーブの計算を伴うクエリを SQL Server に送信する前に、アプリケーション内のクライアント ドライバーで、セキュリティで保護されたエンクレーブが特定のテクノロジ (VBS など) に基づく正規のエンクレーブであり、エンクレーブ内で実行されているコードが、エンクレーブ内で実行するために署名されていることを検証する必要があります。 

エンクレーブを検証するプロセスは、**エンクレーブの構成証明**と呼ばれ、通常、外部の構成証明サービスに接続するアプリケーション (ときには SQL Server も) 内のクライアント ドライバーも含まれます。 構成証明プロセスの詳細は、エンクレーブ テクノロジと構成証明サービスによって変わります。

[!INCLUDE[sql-server-2019](../../../includes/sssqlv15-md.md)] 内の VBS セキュリティで保護されたエンクレーブに対して SQL Server がサポートする構成証明プロセスは、ホスト ガーディアン サービス (HGS) を構成証明サービスとして使用する Windows Defender System Guard ランタイム構成証明です。 お使いの環境で HGS を構成し、SQL Server インスタンスをホストしているマシンを HGS に登録する必要があります。 また、HGS 構成証明を使用してクライアント アプリケーションまたはツール (たとえば、SQL Server Management Studio) も構成する必要があります。

## <a name="secure-enclave-providers"></a>セキュリティで保護されたエンクレーブ プロバイダー

セキュリティで保護されたエンクレーブが設定された Always Encrypted を使用するには、アプリケーションでこの機能をサポートするクライアント ドライバーを使用する必要があります。 [!INCLUDE[sql-server-2019](../../../includes/sssqlv15-md.md)] では、アプリケーションで .NET Framework 4.7.2 と .NET Framework Data Provider for SQL Server を使用する必要があります。 さらに、.NET アプリケーションは、使用しているエンクレーブの種類 (VBS など) や構成証明サービス (HGS など) に固有の**セキュリティで保護されたエンクレーブ プロバイダー**で構成する必要があります。 サポートされているエンクレーブ プロバイダーは、アプリケーションとの統合が必要な NuGet パッケージで個別にリリースされます。 エンクレーブ プロバイダーは、構成証明プロトコルと、特定の種類のセキュリティで保護されたエンクレーブとのセキュリティで保護されたチャネルを確立するためのクライアント側ロジックを実装します。

## <a name="enclave-enabled-keys"></a>エンクレーブ対応キー

セキュリティで保護されたエンクレーブが設定された Always Encrypted では、エンクレーブ対応キーの概念が導入されました。

- **Enclave 対応列マスター キー**: データベース内の列マスター キー メタデータ オブジェクトに ENCLAVE_COMPUTATIONS プロパティが指定されている列マスター キーです。 列マスター キー メタデータ オブジェクトには、メタデータ プロパティの有効な署名も含める必要があります。
- **エンクレーブ対応列暗号化キー**: エンクレーブ対応列マスター キーで暗号化された列暗号化キーです。

SQL Server エンジンは、クエリで指定された操作をセキュリティで保護されたエンクレーブ内で実行する必要があると判断した場合、SQL Server エンジンはクライアント ドライバーに対して、セキュリティで保護されたエンクレーブを使用した計算に必要な列暗号化キーを共有するよう要求します。 クライアント ドライバーは、キーがエンクレーブ対応であり (つまり、エンクレーブ対応列マスター キーを使用して暗号化されており)、適切に署名されている場合にのみ、列暗号化キーを共有します。 それ以外の場合、クエリは失敗します。

## <a name="enclave-enabled-columns"></a>エンクレーブ対応列

エンクレーブ対応列は、エンクレーブ対応列暗号化キーを使用して暗号化されたデータベース列です。 エンクレーブ対応列に使用できる機能は、列が使用している暗号化の種類によって異なります。

- **決定論的な暗号化**: 決定論的な暗号化を使用するエンクレーブ対応列はインプレース暗号化をサポートしていますが、セキュリティで保護されたエンクレーブ内の他の操作はサポートされていません。 等価比較はサポートされていますが、暗号文を (エンクレーブの外部で) 比較することによって、エンクレーブの外部で実行されます。  
- **ランダム化された暗号化**: ランダム化された暗号化を使用するエンクレーブ対応列は、セキュリティで保護されたエンクレーブ内で、インプレース暗号化と高度な計算をサポートしています。 サポートされている高度な計算は、パターン マッチングと等価比較を含む[比較演算子](https://docs.microsoft.com/sql/t-sql/language-elements/comparison-operators-transact-sql)です。

暗号化の種類については、「[Always Encrypted による暗号化](always-encrypted-cryptography.md)」を参照してください。

次の表は、列がエンクレーブ対応列暗号化キーと暗号化の種類を使用するかどうかに応じて、暗号化列に使用できる機能をまとめたものです。

| **操作**| **列はエンクレーブ対応ではない** |**列はエンクレーブ対応ではない**| **列はエンクレーブ対応**  |**列はエンクレーブ対応** |
|:---|:---|:---|:---|:---|
| | **ランダム化された暗号化**  | **決定論的な暗号化**     | **ランダム化された暗号化**      | **決定論的な暗号化**     |
| **インプレース暗号化** | サポートされていません  | サポートされていません   | Supported         | Supported    |
| **等価比較**   | サポートされていません | エンクレーブの外部でサポートされます | (エンクレーブの内部で) サポートされます | エンクレーブの外部でサポートされます |
| **等価かどうか以外の比較演算子** | サポートされていません  | サポートされていません   | Supported      | サポートされていません     |
| **LIKE**    | サポートされていません      | サポートされていません    | Supported     | サポートされていません    |

インプレース暗号化では、エンクレーブ内の次の操作が含まれています。

- 既存の列に格納されているデータの最初の暗号化。
- 次の例のように、列内の既存のデータを再暗号化します。
  
  - 列暗号化キーを交換します (新しいキーで列を再暗号化します)。
  - 暗号化の種類の変更  

- 暗号化された列に格納されているデータを復号化します (列をプレーンテキスト列に変換します)。

インプレース暗号化を可能にするには、暗号化操作に関連する 1 つまたは複数の列暗号化キーをエンクレーブ対応にする必要があります。

- 最初の暗号化: 暗号化される列の列暗号化キーは、エンクレーブ対応にする必要があります。
- 再暗号化: 現在の列暗号化キーとターゲットの列暗号化キー (現在のキーと異なる場合) の両方をエンクレーブ対応にする必要があります。
- 復号化: 列の現在の列暗号化キーはエンクレーブ対応にする必要があります。

## <a name="known-limitations"></a>既知の制限事項

一般的な制限事項: 

- 「[機能の詳細](https://docs.microsoft.com/sql/relational-databases/security/encryption/always-encrypted-database-engine#feature-details)」に現在のバージョンの Always Encrypted について記載されているすべての制限事項は、インプレース暗号化と高度な計算のためにサポートを追加することで削除された制限事項を除き、セキュリティで保護されたエンクレーブが設定された Always Encrypted (エンクレーブ対応キーで暗号化された列) にも適用されます。

- 等価比較は、決定論的な暗号化と共にサポートされている唯一の Transact-SQL 演算子です。また、等価比較は、列暗号化キーがエンクレーブ対応かどうかにかかわらず、エンクレーブの外部で暗号文の値を比較することによって実行されます。 決定論的な暗号化のためのエンクレーブ対応列暗号化キーを使用してロックが解除される唯一の新機能は、インプレース暗号操作です。 決定論的な暗号化を使用して暗号化された列 (およびエンクレーブ対応ではないキー) がある場合、高度な計算 (パターン マッチング、比較操作) を有効にするには、ランダム化された暗号化を使用して列を再暗号化する必要があります。

- 照合の使用に関する既存の制限は、エンクレーブ対応列暗号化キーを使用して暗号化された列に適用されます。決定論的な暗号化を使用して暗号化された文字列型の列 (char、nchar、varchar、nvarchar) は、binary2 の並べ替え順 (BIN2 の照合順序) で照合を使用する必要があります。 BIN2 以外の照合を使用する文字列型の列は、ランダム化された暗号化を使用して暗号化できます。ただし、(エンクレーブ対応列暗号化キーを使用して暗号化している場合) そのような列に対して有効な新機能は、インプレース暗号化のみです。 **高度な計算 (パターン マッチング、比較操作) をサポートするには、列で BIN2 の照合順序を使用する必要があります** (また、ランダム化された暗号化とエンクレーブ対応列暗号化キーを使用して列を暗号化する必要があります)。

- インメモリ テーブルの列にエンクレーブ対応キーを使用することはサポートされていません。

- インプレース暗号化操作は、照合と NULL 値の許容を除き、列メタデータの他の変更と組み合わせることはできません。 たとえば、1 つの ALTER TABLE または ALTER COLUMN Transact-SQL ステートメントで列を暗号化、再暗号化、または復号化し、さらに列のデータ型を変更することはできません。 2 つの別のステートメントを使用する必要があります。

現在のプレビューには以下の制限事項が適用され、対応予定のロードマップ上にあります。

- ランダム化された暗号化を使用するエンクレーブ対応列にインデックスを付けることはできません。つまり、比較操作または LIKE 操作にはテーブル スキャンが必要です。

- セキュリティで保護されたエンクレーブが設定された Always Encrypted をサポートする唯一のクライアント ドライバーは、.NET Framework 4.7.2 内の NET Framework Data Provider for SQL Server (ADO.NET) です。 ODBC/JDBC のサポートはありません。

- エンクレーブ対応列マスター キーを格納するためにサポートされるキー ストアは、Windows 証明書ストアと Azure Key Vault のみです。

- セキュリティで保護されたエンクレーブが設定された Always Encrypted のツールのサポートは、現在のところ不完全です。 ALTER TABLE Transact-SQL ステートメントを使用してインプレース暗号化操作をトリガーするには、SSMS でクエリ ウィンドウを使用してステートメントを発行するか、ステートメントを発行する独自のプログラムを作成する必要があります。 SqlServer PowerShell モジュールの Set-SqlColumnEncryption コマンドレットと SQL Server Management Studio の Always Encrypted ウィザードは、インプレース暗号化をまだサポートしていません。現在、どちらのツールも、操作に使用される列暗号化キーがエンクレーブ対応であっても、暗号化操作のためにデータベースからデータを移動します。 

## <a name="known-issues"></a>既知の問題

- UNICODE (char、varchar) 以外の文字列型の列に対する高度な計算には、データベース レベルで BIN2 照合が設定されている必要があります。 UNICODE 以外の文字列型の列に関する特殊な考慮事項については、「[Manage Collations](configure-always-encrypted-enclaves.md#manage-collations)」(照合順序の管理) を参照してください。

## <a name="next-steps"></a>Next Steps

- テスト環境を設定し、SSMS でセキュリティで保護されたエンクレーブが設定された Always Encrypted の機能を試します。「[Tutorial:Getting started with Always Encrypted with secure enclaves using SSMS](../tutorial-getting-started-with-always-encrypted-enclaves.md)」 (チュートリアル: SSMS を使用するセキュリティで保護されたエンクレーブが設定された Always Encrypted の概要) を参照してください。
